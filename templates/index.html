<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Економетричний аналіз ВРП регіонів України</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #3a4a58;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            border: none;
        }
        .card-header {
            background-color: #4e73df;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            font-weight: bold;
        }
        .correlation-cell {
            text-align: center;
            padding: 10px;
            border-radius: 4px;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #4e73df;
        }
        .prediction-result {
            font-size: 24px;
            font-weight: bold;
            color: #2c7be5;
        }
        #correlationHeatmap {
            height: 400px;
        }
        .coefficient-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background-color: #f1f5fb;
        }
        .r-squared {
            font-size: 18px;
            margin-top: 15px;
            padding: 10px;
            background-color: #e6f2ff;
            border-radius: 5px;
            font-weight: 500;
        }
        .tab-content {
            padding: 20px 0;
        }
        .custom-control-label {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1>Економетричний аналіз ВРП регіонів України</h1>
        <p class="lead">Інтерактивна система для аналізу та прогнозування валового регіонального продукту</p>
    </div>

    <div class="container">
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Інформаційна панель</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="prediction-tab" data-bs-toggle="tab" data-bs-target="#prediction" type="button" role="tab" aria-controls="prediction" aria-selected="false">Прогнозування ВРП</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="correlation-tab" data-bs-toggle="tab" data-bs-target="#correlation" type="button" role="tab" aria-controls="correlation" aria-selected="false">Кореляційна матриця</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab" aria-controls="comparison" aria-selected="false">Порівняння регіонів</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab" aria-controls="about" aria-selected="false">Про проект</button>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabContent">
            <!-- Інформаційна панель -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                Загальна статистика по ВРП регіонів
                            </div>
                            <div class="card-body">
                                <canvas id="regionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                Взаємозалежність між показниками
                            </div>
                            <div class="card-body">
                                <canvas id="scatterChart"></canvas>
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="xVariable" class="form-label">Змінна X:</label>
                                            <select id="xVariable" class="form-select">
                                                {% for var in variables %}
                                                <option value="{{ var }}">{{ var }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="yVariable" class="form-label">Змінна Y:</label>
                                            <select id="yVariable" class="form-select">
                                                <option value="grp">ВРП</option>
                                                {% for var in variables %}
                                                <option value="{{ var }}">{{ var }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                Структура економіки регіонів
                            </div>
                            <div class="card-body">
                                <canvas id="structureChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Прогнозування ВРП -->
            <div class="tab-pane fade" id="prediction" role="tabpanel" aria-labelledby="prediction-tab">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                Налаштування моделі прогнозування
                            </div>
                            <div class="card-body">
                                <form id="predictionForm">
                                    <div class="mb-3">
                                        <label class="form-label">Виберіть змінні для моделі:</label>
                                        <div class="row">
                                            {% for var in variables %}
                                            <div class="col-md-4 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input variable-checkbox" type="checkbox" value="{{ var }}" id="var_{{ var }}" name="variables" {% if var in default_vars %}checked{% endif %}>
                                                    <label class="form-check-label" for="var_{{ var }}">
                                                        {{ var }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Введіть значення для прогнозу:</label>
                                        <div class="row values-inputs">
                                            {% for var in variables %}
                                            <div class="col-md-6 mb-2 var-input-container" id="input_container_{{ var }}" {% if var not in default_vars %}style="display: none;"{% endif %}>
                                                <label for="value_{{ var }}" class="form-label">{{ var }}:</label>
                                                <input type="number" class="form-control" id="value_{{ var }}" name="values[{{ var }}]" step="0.01">
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Або виберіть регіон для заповнення значень:</label>
                                        <select class="form-select" id="regionSelect">
                                            <option value="">-- Виберіть регіон --</option>
                                            {% for region in regions %}
                                            <option value="{{ region }}">{{ region }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">Розрахувати прогноз</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                Результат прогнозування
                            </div>
                            <div class="card-body text-center">
                                <div id="loadingPrediction" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Завантаження...</span>
                                    </div>
                                </div>
                                <div id="predictionResult">
                                    <h5>Прогнозований ВРП:</h5>
                                    <div class="prediction-result" id="predictedGRP">-</div>
                                    <div class="mt-3">
                                        <h6>Коефіцієнти моделі:</h6>
                                        <div id="coefficientsList"></div>
                                    </div>
                                    <div class="r-squared" id="rSquaredValue"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Кореляційна матриця -->
            <div class="tab-pane fade" id="correlation" role="tabpanel" aria-labelledby="correlation-tab">
                <div class="card">
                    <div class="card-header">
                        Кореляційна матриця показників
                    </div>
                    <div class="card-body">
                        <div id="correlationHeatmap"></div>
                        <div class="mt-4">
                            <h5>Інтерпретація кореляційної матриці:</h5>
                            <ul>
                                <li>Значення близькі до 1 означають сильну позитивну кореляцію</li>
                                <li>Значення близькі до -1 означають сильну негативну кореляцію</li>
                                <li>Значення близькі до 0 означають відсутність лінійної кореляції</li>
                            </ul>
                            <p><strong>Важливо:</strong> Висока кореляція не обов'язково означає причинно-наслідковий зв'язок.</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        Фактори інфляції дисперсії (VIF)
                    </div>
                    <div class="card-body">
                        <p>Фактор інфляції дисперсії (VIF) допомагає виявити мультиколінеарність між змінними. Високі значення VIF (зазвичай > 10) вказують на сильну мультиколінеарність.</p>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Змінна</th>
                                    <th>VIF</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vif in vif_data %}
                                <tr>
                                    <td>{{ vif.feature }}</td>
                                    <td>{{ "%.2f"|format(vif.VIF) }}</td>
                                    <td>
                                        {% if vif.VIF > 10 %}
                                        <span class="badge bg-danger">Висока колінеарність</span>
                                        {% elif vif.VIF > 5 %}
                                        <span class="badge bg-warning">Середня колінеарність</span>
                                        {% else %}
                                        <span class="badge bg-success">Низька колінеарність</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Порівняння регіонів -->
            <div class="tab-pane fade" id="comparison" role="tabpanel" aria-labelledby="comparison-tab">
                <div class="card">
                    <div class="card-header">
                        Порівняння показників регіонів
                    </div>
                    <div class="card-body">
                        <form id="comparisonForm" class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Виберіть регіони для порівняння:</label>
                                    <select class="form-select" id="comparisonRegions" multiple size="8">
                                        {% for region in regions %}
                                        <option value="{{ region }}">{{ region }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Натисність Ctrl або Cmd для вибору декількох регіонів</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Виберіть показники для порівняння:</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="comp_grp" value="grp" checked>
                                            <label class="form-check-label" for="comp_grp">ВРП</label>
                                        </div>
                                        {% for var in variables %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="comp_{{ var }}" value="{{ var }}">
                                            <label class="form-check-label" for="comp_{{ var }}">{{ var }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">Порівняти</button>
                        </form>
                        
                        <div id="comparisonChartContainer" style="display: none;">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                        
                        <div id="comparisonTableContainer" style="display: none;">
                            <h5 class="mt-4">Детальне порівняння:</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="comparisonTable">
                                    <thead id="comparisonTableHead"></thead>
                                    <tbody id="comparisonTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Про проект -->
            <div class="tab-pane fade" id="about" role="tabpanel" aria-labelledby="about-tab">
                <div class="card">
                    <div class="card-header">
                        Про проект
                    </div>
                    <div class="card-body">
                        <h5>Економетричний аналіз ВРП регіонів України</h5>
                        <p>Цей проект дозволяє проводити економетричний аналіз валового регіонального продукту (ВРП) регіонів України на основі соціально-економічних показників за 2004 рік.</p>
                        
                        <h5 class="mt-4">Основні можливості:</h5>
                        <ul>
                            <li>Аналіз взаємозв'язків між різними економічними показниками</li>
                            <li>Побудова регресійних моделей для прогнозування ВРП</li>
                            <li>Виявлення мультиколінеарності між змінними</li>
                            <li>Візуалізація економічних даних</li>
                            <li>Порівняння показників різних регіонів</li>
                        </ul>
                        
                        <h5 class="mt-4">Технології:</h5>
                        <ul>
                            <li><strong>Backend:</strong> Python, Flask, scikit-learn, statsmodels, pandas</li>
                            <li><strong>Frontend:</strong> HTML, JavaScript, Bootstrap, Chart.js</li>
                            <li><strong>Аналіз даних:</strong> Регресійний аналіз, кореляційний аналіз, виявлення мультиколінеарності</li>
                        </ul>
                        
                        <div class="mt-4">
                            <p><strong>Примітка:</strong> Цей проект призначений для навчальних цілей з економетрики. Дані взяті з офіційних джерел статистичної інформації України за 2004 рік.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">Економетричний аналізатор регіонів України © 2025</p>
        </div>
    </footer>

    <!-- Передача даних з Python в JavaScript -->
    <script>
        const regionsData = {{ data_json|safe }};
        const correlationMatrix = {{ corr_data|safe }};
        
        // Зберігання основних змінних
        const variables = {{ variables|tojson|safe }};
        const defaultVars = {{ default_vars|tojson|safe }};
        
        // Коефіцієнти моделі
        const initialCoefficients = {{ model_result.coefficients|tojson|safe }};
        const initialRSquared = {{ model_result.r_squared }};
        const predictionResults = {{ model_result.predicted_values|tojson|safe }};
    </script>
    
    <!-- JavaScript для управління інтерфейсом та взаємодії з сервером -->
    <script>
        $(document).ready(function() {
            // Початкова ініціалізація
            initDashboard();
            initPredictionTab();
            initCorrelationTab();
            initComparisonTab();
            
            // Обробка переключення вкладок
            $('#mainTab button').on('click', function (e) {
                e.preventDefault();
                $(this).tab('show');
            });
            
            // Функція для ініціалізації інформаційної панелі
            function initDashboard() {
                // Створення графіку ВРП за регіонами
                const regionsCtx = document.getElementById('regionsChart').getContext('2d');
                const regionsChart = new Chart(regionsCtx, {
                    type: 'bar',
                    data: {
                        labels: regionsData.map(r => r.region),
                        datasets: [{
                            label: 'Валовий регіональний продукт (млн грн)',
                            data: regionsData.map(r => r.grp),
                            backgroundColor: 'rgba(78, 115, 223, 0.8)',
                            borderColor: 'rgba(78, 115, 223, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ВРП (млн грн)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Ініціалізація діаграми розсіювання
                updateScatterChart('investments', 'grp');
                
                // Обробник зміни змінних для діаграми розсіювання
                $('#xVariable, #yVariable').on('change', function() {
                    const xVar = $('#xVariable').val();
                    const yVar = $('#yVariable').val();
                    updateScatterChart(xVar, yVar);
                });
                
                // Ініціалізація структурної діаграми
                const structureCtx = document.getElementById('structureChart').getContext('2d');
                const structureChart = new Chart(structureCtx, {
                    type: 'radar',
                    data: {
                        labels: variables,
                        datasets: regionsData.slice(0, 5).map((region, index) => {
                            const colors = [
                                'rgba(78, 115, 223, 0.6)',
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(255, 205, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)'
                            ];
                            return {
                                label: region.region,
                                data: variables.map(v => {
                                    // Нормалізація даних для радарної діаграми
                                    const values = regionsData.map(r => r[v]);
                                    const max = Math.max(...values);
                                    return region[v] / max * 100;
                                }),
                                backgroundColor: colors[index],
                                borderColor: colors[index].replace('0.6', '1'),
                                borderWidth: 1,
                                pointBackgroundColor: colors[index].replace('0.6', '1')
                            };
                        })
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0.1
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                ticks: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Оновлення діаграми розсіювання
            function updateScatterChart(xVar, yVar) {
                const scatterCtx = document.getElementById('scatterChart').getContext('2d');
                
                // Знищуємо старий графік, якщо він існує
                if (window.scatterChart) {
                    window.scatterChart.destroy();
                }
                
                // Отримуємо значення коефіцієнта кореляції
                const correlationValue = correlationMatrix[yVar][xVar].toFixed(2);
                
                // Створюємо новий графік
                window.scatterChart = new Chart(scatterCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${yVar} vs ${xVar} (кореляція: ${correlationValue})`,
                            data: regionsData.map(region => ({
                                x: region[xVar],
                                y: region[yVar],
                                region: region.region
                            })),
                            backgroundColor: 'rgba(78, 115, 223, 0.6)',
                            borderColor: 'rgba(78, 115, 223, 1)',
                            borderWidth: 1,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: xVar
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: yVar
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return `${point.region}: ${xVar}=${point.x}, ${yVar}=${point.y}`;
                                    }
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Ініціалізація вкладки прогнозування
            function initPredictionTab() {
                // Обробник зміни вибраних змінних
                $('.variable-checkbox').on('change', function() {
                    const variable = $(this).val();
                    const inputContainer = $(`#input_container_${variable}`);
                    
                    if ($(this).is(':checked')) {
                        inputContainer.show();
                    } else {
                        inputContainer.hide();
                    }
                });
                
                // Початкове відображення коефіцієнтів
                updateCoefficientsList(initialCoefficients, initialRSquared);
                
                // Обробник вибору регіону для заповнення значень
                $('#regionSelect').on('change', function() {
                    const selectedRegion = $(this).val();
                    
                    if (selectedRegion) {
                        const regionData = regionsData.find(r => r.region === selectedRegion);
                        
                        if (regionData) {
                            variables.forEach(variable => {
                                $(`#value_${variable}`).val(regionData[variable]);
                            });
                        }
                    }
                });
                
                // Обробник відправки форми прогнозування
                $('#predictionForm').on('submit', function(e) {
                    e.preventDefault();
                    
                    // Збираємо вибрані змінні
                    const selectedVars = [];
                    $('.variable-checkbox:checked').each(function() {
                        selectedVars.push($(this).val());
                    });
                    
                    if (selectedVars.length === 0) {
                        alert('Будь ласка, виберіть хоча б одну змінну для моделі');
                        return;
                    }
                    
                    // Збираємо значення змінних
                    const values = {};
                    selectedVars.forEach(variable => {
                        values[variable] = parseFloat($(`#value_${variable}`).val());
                        
                        if (isNaN(values[variable])) {
                            alert(`Будь ласка, введіть числове значення для ${variable}`);
                            return;
                        }
                    });
                    
                    // Відправка даних на сервер
                    $('#loadingPrediction').show();
                    
                    fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            variables: selectedVars,
                            values: values
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        $('#loadingPrediction').hide();
                        
                        if (data.error) {
                            alert('Помилка: ' + data.error);
                            return;
                        }
                        
                        // Відображення результату
                        $('#predictedGRP').text(Math.round(data.predicted_grp).toLocaleString() + ' млн грн');
                        updateCoefficientsList(data.coefficients, data.r_squared);
                    })
                    .catch(error => {
                        $('#loadingPrediction').hide();
                        alert('Помилка при відправці запиту: ' + error);
                    });
                });
            }
            
            // Оновлення списку коефіцієнтів
            function updateCoefficientsList(coefficients, rSquared) {
                const coefficientsList = $('#coefficientsList');
                coefficientsList.empty();
                
                for (const [variable, value] of Object.entries(coefficients)) {
                    const displayVar = variable === 'const' ? 'Вільний член' : variable;
                    const coefficient = Math.round(value * 1000) / 1000;
                    
                    coefficientsList.append(
                        `<div class="coefficient-item">
                            <strong>${displayVar}:</strong> ${coefficient}
                        </div>`
                    );
                }
                
                // Відображення R-квадрат
                $('#rSquaredValue').text(`R²: ${(rSquared * 100).toFixed(2)}%`);
            }
            
            // Ініціалізація вкладки кореляційної матриці
            function initCorrelationTab() {
                const heatmapCtx = document.getElementById('correlationHeatmap').getContext('2d');
                
                // Підготовка даних для теплової карти
                const variables = ['grp', ...Object.keys(correlationMatrix).filter(k => k !== 'grp')];
                
                // Створення даних для теплової карти
                const heatmapData = [];
                for (let i = 0; i < variables.length; i++) {
                    for (let j = 0; j < variables.length; j++) {
                        const value = correlationMatrix[variables[i]][variables[j]];
                        heatmapData.push({
                            x: variables[j],
                            y: variables[i],
                            v: value
                        });
                    }
                }
                
                // Функція для вибору кольору на основі значення кореляції
                function getColor(value) {
                    if (value >= 0.8) return 'rgba(42, 120, 220, 0.9)';
                    if (value >= 0.6) return 'rgba(42, 120, 220, 0.7)';
                    if (value >= 0.4) return 'rgba(42, 120, 220, 0.5)';
                    if (value >= 0.2) return 'rgba(42, 120, 220, 0.3)';
                    if (value >= 0) return 'rgba(221, 221, 221, 0.5)';
                    if (value >= -0.2) return 'rgba(219, 68, 55, 0.3)';
                    if (value >= -0.4) return 'rgba(219, 68, 55, 0.5)';
                    if (value >= -0.6) return 'rgba(219, 68, 55, 0.7)';
                    return 'rgba(219, 68, 55, 0.9)';
                }
                
                // Створення теплової карти
                window.heatmapChart = new Chart(heatmapCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Кореляційна матриця',
                            data: heatmapData,
                            backgroundColor: context => getColor(context.raw.v),
                            pointRadius: 15,
                            pointHoverRadius: 15
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'category',
                                position: 'top',
                                labels: variables,
                                title: {
                                    display: true,
                                    text: 'Змінні'
                                }
                            },
                            y: {
                                type: 'category',
                                labels: variables,
                                reverse: true,
                                title: {
                                    display: true,
                                    text: 'Змінні'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return `${point.y} і ${point.x}: ${point.v.toFixed(3)}`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Додаємо значення кореляції на теплову карту
                Chart.register({
                    id: 'correlationValues',
                    afterDraw: (chart) => {
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        chart.data.datasets[0].data.forEach((point, index) => {
                            const meta = chart.getDatasetMeta(0);
                            const element = meta.data[index];
                            
                            if (element.active) return;
                            
                            ctx.fillStyle = Math.abs(point.v) > 0.5 ? 'white' : 'black';
                            ctx.fillText(point.v.toFixed(2), element.x, element.y);
                        });
                        
                        ctx.restore();
                    }
                });
            }
            
            // Ініціалізація вкладки порівняння регіонів
            function initComparisonTab() {
                // Обробник відправки форми порівняння
                $('#comparisonForm').on('submit', function(e) {
                    e.preventDefault();
                    
                    // Збираємо вибрані регіони
                    const selectedRegions = [];
                    $('#comparisonRegions option:selected').each(function() {
                        selectedRegions.push($(this).val());
                    });
                    
                    if (selectedRegions.length === 0) {
                        alert('Будь ласка, виберіть хоча б один регіон для порівняння');
                        return;
                    }
                    
                    // Збираємо вибрані показники
                    const selectedVars = [];
                    $('input[id^=comp_]:checked').each(function() {
                        selectedVars.push($(this).val());
                    });
                    
                    if (selectedVars.length === 0) {
                        alert('Будь ласка, виберіть хоча б один показник для порівняння');
                        return;
                    }
                    
                    // Відправка даних на сервер
                    fetch('/compare_regions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            regions: selectedRegions,
                            variables: selectedVars
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Помилка: ' + data.error);
                            return;
                        }
                        
                        // Відображення графіку порівняння
                        updateComparisonChart(data, selectedRegions, selectedVars);
                        
                        // Відображення таблиці порівняння
                        updateComparisonTable(data, selectedVars);
                    })
                    .catch(error => {
                        alert('Помилка при відправці запиту: ' + error);
                    });
                });
            }
            
            // Оновлення графіку порівняння
            function updateComparisonChart(data, regions, variables) {
                const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
                
                // Знищуємо старий графік, якщо він існує
                if (window.comparisonChart) {
                    window.comparisonChart.destroy();
                }
                
                // Нормалізуємо дані для порівняння
                const normalizedData = {};
                
                variables.forEach(variable => {
                    const values = data.map(item => item[variable]);
                    const max = Math.max(...values);
                    
                    normalizedData[variable] = {};
                    data.forEach(item => {
                        normalizedData[variable][item.region] = (item[variable] / max) * 100;
                    });
                });
                
                // Створюємо новий графік
                window.comparisonChart = new Chart(comparisonCtx, {
                    type: 'radar',
                    data: {
                        labels: variables,
                        datasets: regions.map((region, index) => {
                            const colors = [
                                'rgba(78, 115, 223, 0.6)',
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(255, 205, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(201, 203, 207, 0.6)'
                            ];
                            
                            return {
                                label: region,
                                data: variables.map(variable => normalizedData[variable][region]),
                                backgroundColor: colors[index % colors.length],
                                borderColor: colors[index % colors.length].replace('0.6', '1'),
                                borderWidth: 1,
                                pointBackgroundColor: colors[index % colors.length].replace('0.6', '1')
                            };
                        })
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0.1
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                ticks: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                $('#comparisonChartContainer').show();
            }
            
            // Оновлення таблиці порівняння
            function updateComparisonTable(data, variables) {
                const thead = $('#comparisonTableHead');
                const tbody = $('#comparisonTableBody');
                
                // Очищаємо таблицю
                thead.empty();
                tbody.empty();
                
                // Створюємо заголовок таблиці
                const headerRow = $('<tr>');
                headerRow.append('<th>Регіон</th>');
                
                variables.forEach(variable => {
                    headerRow.append(`<th>${variable}</th>`);
                });
                
                thead.append(headerRow);
                
                // Заповнюємо тіло таблиці
                data.forEach(item => {
                    const row = $('<tr>');
                    row.append(`<td>${item.region}</td>`);
                    
                    variables.forEach(variable => {
                        row.append(`<td>${item[variable].toLocaleString()}</td>`);
                    });
                    
                    tbody.append(row);
                });
                
                $('#comparisonTableContainer').show();
            }
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>